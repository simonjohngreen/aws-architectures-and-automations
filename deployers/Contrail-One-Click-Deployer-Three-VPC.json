{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Deploy and build Contrail Command plus networks routers subnets securty groups and bare metals ready to deploy with the UI",
    "Parameters": {
        "AvailabilityZone" : {
          "Description" : "AWS Availability Zone",
          "Type" : "String",
          "Default": "eu-central-1a"
        },
        "AvailabilityZone2" : {
          "Description" : "AWS Availability Zone",
          "Type" : "String",
          "Default": "eu-central-1b"
        },
        "ContrailAMI": {
            "Description": "ContrailCommand AMI CentOS 7",
            "Type": "String",
            "Default": "ami-04cf43aca3e6f3de3"
        },
        "ControllerInstanceType": {
            "Description": "Contrail Command Instance Type",
            "Type": "String",
            "Default": "m4.2xlarge"
        },
        "k8minionInstanceType": {
            "Description": "Contrail Command Instance Type",
            "Type": "String",
            "Default": "m4.xlarge"
        },
        "KeyName": {
            "Description": "SSH Key Name",
            "Type": "AWS::EC2::KeyPair::KeyName",
            "Default": "OneClickKey1"
        },
        "ContainerRegistryTag": {
            "Description": "Container Registry User Name",
            "Type": "String",
            "Default": "2008.121"
        },
        "ContainerRegistryUserName": {
            "Description": "Container Registry User Name",
            "Type": "String"
        },
        "ContainerRegistryPassword": {
            "Description": "Container Registry User Password",
            "Type": "String",
            "NoEcho": true
        },
        "VPCCIDR": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Description": "CIDR block for entire VPC.",
            "Default": "100.72.100.0/23",
            "Type": "String"
        },
        "VPCCIDR2": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Description": "CIDR block for entire VPC.",
            "Default": "100.73.100.0/23",
            "Type": "String"
        },
        "VPCCIDR3": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Description": "CIDR block for entire VPC.",
            "Default": "100.74.100.0/23",
            "Type": "String"
        },
        "PublicSubnetCIDR": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Description": "CIDR block for the public subnet",
            "Default": "100.72.100.0/25",
            "Type": "String"
        },
        "PrivateSubnetCIDR": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Description": "CIDR block for the private subnet",
            "Default": "100.72.100.128/25",
            "Type": "String"
        },
        "PrivateSubnetGatewayIP": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})",
            "ConstraintDescription": "parameter must be in the form x.x.x.x",
            "Description": "Gateway IP address for the for the private subnet used by contrail command as its the nat box",
            "Default": "100.72.100.129",
            "Type": "String"
        },
        "PublicSubnetCIDR2": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Description": "CIDR block for the public subnet",
            "Default": "100.73.100.0/25",
            "Type": "String"
        },
        "PrivateSubnetCIDR2": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Description": "CIDR block for the private subnet",
            "Default": "100.73.100.128/25",
            "Type": "String"
        },
        "PrivateSubnetGatewayIP2": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})",
            "ConstraintDescription": "parameter must be in the form x.x.x.x",
            "Description": "Gateway IP address for the for the private subnet used by the VPC2 MCGW1-1",
            "Default": "100.73.100.129",
            "Type": "String"
        },
        "PublicSubnetCIDR3": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Description": "CIDR block for the public subnet",
            "Default": "100.74.100.0/25",
            "Type": "String"
        },
        "PrivateSubnetCIDR3": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Description": "CIDR block for the private subnet",
            "Default": "100.74.100.128/25",
            "Type": "String"
        },
        "PrivateSubnetGatewayIP3": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})",
            "ConstraintDescription": "parameter must be in the form x.x.x.x",
            "Description": "Gateway IP address for the for the private subnet used by the VPC2 MCGW2-1",
            "Default": "100.74.100.129",
            "Type": "String"
        },
        "ContrailCommandPublicIP" : {
          "Description" : "OpenVPN public static IP",
          "Type" : "String",
          "Default": "100.72.100.10"
        },
        "ContrailCommandPrivateIP" : {
          "Description" : "OpenVPN private static IP",
          "Type" : "String",
          "Default": "100.72.100.138"
        },
        "ContrailControllerPrivateIP" : {
          "Description" : "OpenVPN private static IP",
          "Type" : "String",
          "Default": "100.72.100.139"
        },
        "MCGW11PublicIP" : {
          "Description" : "OpenVPN public static IP",
          "Type" : "String",
          "Default": "100.73.100.10"
        },
        "MCGW11PrivateIP" : {
          "Description" : "OpenVPN private static IP",
          "Type" : "String",
          "Default": "100.73.100.138"
        },
        "MCGW21PublicIP" : {
          "Description" : "OpenVPN public static IP",
          "Type" : "String",
          "Default": "100.74.100.10"
        },
        "MCGW21PrivateIP" : {
          "Description" : "OpenVPN private static IP",
          "Type" : "String",
          "Default": "100.74.100.138"
        },
        "k8minion11PrivateIP" : {
          "Description" : "OpenVPN private static IP",
          "Type" : "String",
          "Default": "100.73.100.140"
        },
        "k8minion21PrivateIP" : {
          "Description" : "OpenVPN private static IP",
          "Type" : "String",
          "Default": "100.74.100.140"
        },
        "UserLocation" : {
          "Description" : "The IP address range that can be used to SSH to the EC2 instances",
          "Type": "String",
          "MinLength": "9",
          "MaxLength": "18",
          "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
          "Default": "0.0.0.0/0",
          "ConstraintDescription": "Put your IP here x.x.x.x/32, if you leave it blank then 0.0.0.0/0 will be spopulated and the internet will be able access your deployments UI and SSH"
        },
        "SiteName" : {
          "Description" : "Site Name",
          "Type" : "String",
          "Default": "ContrailBareMetalControl"
        },
        "VPCDOMAIN" : {
          "Description" : "VCP domain type",
          "Type" : "String",
          "Default": "default"
   	},
        "SSHPassword" : {
          "Description" : "VCP domain type",
          "Type" : "String",
          "Default": "EfrtGF5EDF_d54ERrf"
   	},
        "ContrailPassword" : {
          "Description" : "VCP domain type",
          "Type" : "String",
          "Default": "contrail123"
   	}
    },
    "Resources": {
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": {
                    "Ref": "VPCCIDR"
                },
                "InstanceTenancy": { "Ref" : "VPCDOMAIN" },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClick", { "Ref" : "SiteName" } ] ] }
                    }
                ]
            }
        },
        "VPC2": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": {
                    "Ref": "VPCCIDR2"
                },
                "InstanceTenancy": { "Ref" : "VPCDOMAIN" },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClick2", { "Ref" : "SiteName" } ] ] }
                    }
                ]
            }
        },
        "VPC3": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": {
                    "Ref": "VPCCIDR3"
                },
                "InstanceTenancy": { "Ref" : "VPCDOMAIN" },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClick3", { "Ref" : "SiteName" } ] ] }
                    }
                ]
            }
        },
        "PublicSubnet": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone" : { "Ref" : "AvailabilityZone" },
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": {
                    "Ref": "PublicSubnetCIDR"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClickPublicSN1", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },
        "PublicSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone" : { "Ref" : "AvailabilityZone" },
                "VpcId": {
                    "Ref": "VPC2"
                },
                "CidrBlock": {
                    "Ref": "PublicSubnetCIDR2"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClickPublicSN2", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },
        "PublicSubnet3": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone" : { "Ref" : "AvailabilityZone2" },
                "VpcId": {
                    "Ref": "VPC3"
                },
                "CidrBlock": {
                    "Ref": "PublicSubnetCIDR3"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClickPublicSN3", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },
        "PrivateSubnet": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone" : { "Ref" : "AvailabilityZone" },
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnetCIDR"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClickPrivateSN1", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },

        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone" : { "Ref" : "AvailabilityZone" },
                "VpcId": {
                    "Ref": "VPC2"
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnetCIDR2"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClickPrivateSN2", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },
        "PrivateSubnet3": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone" : { "Ref" : "AvailabilityZone2" },
                "VpcId": {
                    "Ref": "VPC3"
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnetCIDR3"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClickPrivateSN3", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClickInternetGW1", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },
        "InternetGateway2": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClickInternetGW2", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },
        "InternetGateway3": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClickInternetGW3", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },
        "AttachGateway": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "AttachGateway2": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC2"
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway2"
                }
            }
        },
        "AttachGateway3": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC3"
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway3"
                }
            }
        },
        "NATEIP": {
            "Type": "AWS::EC2::EIP",
            "Properties": {
                "Domain": "vpc"
            }
        },
        "NAT": {
            "DependsOn": "AttachGateway",
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NATEIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClickNATGW1", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },
        "PrivateSubnetRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneCliclPrivateRouteTable1", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    },
                    {
                        "Key": "CloudFormationStack",
                        "Value": {
                            "Ref": "AWS::StackId"
                        }
                    }
                ]
            }
        },
        "PrivateSubnetRoute": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateSubnetRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NAT"
                }
            }
        },
        "PrivateSubnetRouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet"
                },
                "RouteTableId": {
                    "Ref": "PrivateSubnetRouteTable"
                }
            }
        },
        "PrivateSubnetRouteTable2": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC2"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneCliclPrivateRouteTable2", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    },
                    {
                        "Key": "CloudFormationStack",
                        "Value": {
                            "Ref": "AWS::StackId"
                        }
                    }
                ]
            }
        },
        "PrivateSubnetRoute2": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateSubnetRouteTable2"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NetworkInterfaceId": {
                    "Ref": "Eth1MCGW11"
                }
            }
        },
        "PrivateSubnetRouteTableAssociation2": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                },
                "RouteTableId": {
                    "Ref": "PrivateSubnetRouteTable2"
                }
            }
        },
        "PrivateSubnetRouteTable3": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC3"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneCliclPrivateRouteTable3", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    },
                    {
                        "Key": "CloudFormationStack",
                        "Value": {
                            "Ref": "AWS::StackId"
                        }
                    }
                ]
            }
        },
        "PrivateSubnetRoute3": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateSubnetRouteTable3"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NetworkInterfaceId": {
                    "Ref": "Eth1MCGW21"
                }
            }
        },
        "PrivateSubnetRouteTableAssociation3": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet3"
                },
                "RouteTableId": {
                    "Ref": "PrivateSubnetRouteTable3"
                }
            }
        },

        "RouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClickPubicSubnetRouteTable1", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },
        "Route": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "AttachGateway",
            "Properties": {
                "RouteTableId": {
                    "Ref": "RouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "SubnetRouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet"
                },
                "RouteTableId": {
                    "Ref": "RouteTable"
                }
            }
        },
        "RouteTable2": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC2"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClickPubicSubnetRouteTable2", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },
        "Route2": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "AttachGateway2",
            "Properties": {
                "RouteTableId": {
                    "Ref": "RouteTable2"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway2"
                }
            }
        },
        "SubnetRouteTableAssociation2": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                },
                "RouteTableId": {
                    "Ref": "RouteTable2"
                }
            }
        },



        "RouteTable3": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC3"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClickPubicSubnetRouteTable3", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },
        "Route3": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "AttachGateway3",
            "Properties": {
                "RouteTableId": {
                    "Ref": "RouteTable3"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway3"
                }
            }
        },
        "SubnetRouteTableAssociation3": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet3"
                },
                "RouteTableId": {
                    "Ref": "RouteTable3"
                }
            }
        },
        "IPAddress": {
            "Type": "AWS::EC2::EIP",
            "Properties": {
                "Domain": "vpc"
            }
        },
        "IPAddress2": {
            "Type": "AWS::EC2::EIP",
            "Properties": {
                "Domain": "vpc"
            }
        },
        "IPAddress3": {
            "Type": "AWS::EC2::EIP",
            "Properties": {
                "Domain": "vpc"
            }
        },
        "SecurityGroupContrailCommand": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "GroupDescription": "Security group for Contrail Comand public and on internet",
                "GroupName" : { "Fn::Join" : [ ".", [ "OneCLick Contrail Command public SG", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 9090,
                        "ToPort": 9090,
                        "CidrIp": {"Ref" : "UserLocation"},
                        "Description": "allow access to the Contrail Comand UI"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 9091,
                        "ToPort": 9091,
                        "CidrIp": {"Ref" : "UserLocation"},
                        "Description": "allow access to the Contrail Comand API"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 8143,
                        "ToPort": 8143,
                        "CidrIp": {"Ref" : "UserLocation"},
                        "Description": "allow access to the Contrail UI"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 1139,
                        "ToPort": 1139,
                        "CidrIp": {"Ref" : "UserLocation"},
                        "Description": "allow Contrail and K8S Controller Access"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": {"Ref" : "UserLocation"},
                        "Description": "allow ssh access"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 2138,
                        "ToPort": 2138,
                        "CidrIp": {"Ref" : "UserLocation"},
                        "Description": "allow ssh access"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 3138,
                        "ToPort": 3138,
                        "CidrIp": {"Ref" : "UserLocation"},
                        "Description": "allow ssh access"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 2140,
                        "ToPort": 2140,
                        "CidrIp": {"Ref" : "UserLocation"},
                        "Description": "allow ssh access"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 3140,
                        "ToPort": 3140,
                        "CidrIp": {"Ref" : "UserLocation"},
                        "Description": "allow ssh access"
                    },
                    {
                        "IpProtocol": "-1",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": {"Ref" : "VPCCIDR"},
                        "Description": "allow access to the Contrail Instances within the VPC"
                    },
                    {
                        "IpProtocol": "-1",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": {"Ref" : "VPCCIDR2"},
                        "Description": "allow access to the Contrail Instances within the VPC2"
                    },
                    {
                        "IpProtocol": "-1",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": {"Ref" : "VPCCIDR3"},
                        "Description": "allow access to the Contrail Instances within the VPC3"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": "0.0.0.0/0",
                        "Description": "allow all outbound traffic"
		    }
		],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClick Contrail Command Security Group", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },
        "SecurityGroupContrailVPC1": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "GroupDescription": "Security group for Contrail Instances on the Private SN",
                "GroupName" : { "Fn::Join" : [ ".", [ "OneCLick Contrail Private SG", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "-1",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": {"Ref" : "VPCCIDR"},
                        "Description": "allow access to the Contrail Instances within the VPC"
                    },
                    {
                        "IpProtocol": "-1",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": {"Ref" : "VPCCIDR2"},
                        "Description": "allow access to the Contrail Instances within the VPC2"
                    },
                    {
                        "IpProtocol": "-1",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": {"Ref" : "VPCCIDR3"},
                        "Description": "allow access to the Contrail Instances within the VPC3"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": "0.0.0.0/0",
                        "Description": "allow all outbound traffic"
		    }
		],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "VPC1 OneClick Contrail Instance Private Security Group", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },


        "SecurityGroupContrailVPC2": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC2"
                },
                "GroupDescription": "VPC2 Security group for Contrail Instances on the Private SN",
                "GroupName" : { "Fn::Join" : [ ".", [ "OneCLick Contrail Private SG", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "-1",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": {"Ref" : "VPCCIDR"},
                        "Description": "allow access to the Contrail Instances within the VPC"
                    },
                    {
                        "IpProtocol": "-1",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": {"Ref" : "VPCCIDR2"},
                        "Description": "allow access to the Contrail Instances within the VPC2"
                    },
                    {
                        "IpProtocol": "-1",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": {"Ref" : "VPCCIDR3"},
                        "Description": "allow access to the Contrail Instances within the VPC3"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": "0.0.0.0/0",
                        "Description": "allow all outbound traffic"
		    }
		],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClick Contrail Instance Private Security Group", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },

        "SecurityGroupContrailVPC3": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC3"
                },
                "GroupDescription": "VPC3 Security group for Contrail Instances on the Private SN",
                "GroupName" : { "Fn::Join" : [ ".", [ "OneCLick Contrail Private SG", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "-1",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": {"Ref" : "VPCCIDR"},
                        "Description": "allow access to the Contrail Instances within the VPC"
                    },
                    {
                        "IpProtocol": "-1",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": {"Ref" : "VPCCIDR2"},
                        "Description": "allow access to the Contrail Instances within the VPC2"
                    },
                    {
                        "IpProtocol": "-1",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": {"Ref" : "VPCCIDR3"},
                        "Description": "allow access to the Contrail Instances within the VPC3"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "FromPort": "-1",
                        "ToPort": "-1",
                        "CidrIp": "0.0.0.0/0",
                        "Description": "allow all outbound traffic"
		    }
		],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": { "Fn::Join" : [ ".", [ "OneClick Contrail Instance Private Security Group", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                    }
                ]
            }
        },

        "SGIngressSecurityGroupContrailVPC1": {
          "Type": "AWS::EC2::SecurityGroupIngress",
          "Properties": {
            "GroupId" : {
              "Ref" : "SecurityGroupContrailVPC1"
            },
            "IpProtocol": "-1",
            "FromPort": "-1",
            "ToPort": "-1",
            "SourceSecurityGroupId": {
              "Ref": "SecurityGroupContrailVPC1"
            },
            "Description": "loopback rule"
          }
        },
        "SGIngressSecurityGroupContrailVPC2": {
          "Type": "AWS::EC2::SecurityGroupIngress",
          "Properties": {
            "GroupId" : {
              "Ref" : "SecurityGroupContrailVPC2"
            },
            "IpProtocol": "-1",
            "FromPort": "-1",
            "ToPort": "-1",
            "SourceSecurityGroupId": {
              "Ref": "SecurityGroupContrailVPC2"
            },
            "Description": "loopback rule"
          }
        },
        "SGIngressSecurityGroupContrailVPC3": {
          "Type": "AWS::EC2::SecurityGroupIngress",
          "Properties": {
            "GroupId" : {
              "Ref" : "SecurityGroupContrailVPC3"
            },
            "IpProtocol": "-1",
            "FromPort": "-1",
            "ToPort": "-1",
            "SourceSecurityGroupId": {
              "Ref": "SecurityGroupContrailVPC3"
            },
            "Description": "loopback rule"
          }
        },
        "SGIngressSecurityGroupContrailCommand": {
          "Type": "AWS::EC2::SecurityGroupIngress",
          "Properties": {
            "GroupId" : {
              "Ref" : "SecurityGroupContrailCommand"
            },
            "IpProtocol": "-1",
            "FromPort": "-1",
            "ToPort": "-1",
            "SourceSecurityGroupId": {
              "Ref": "SecurityGroupContrailCommand"
            },
            "Description": "loopback rule"
          }
        },
        "ContrailCommandInstance": {
          "Type": "AWS::EC2::Instance",
          "DependsOn": [ "IPAddress", "PrivateSubnet", "Eth0Command", "Eth1Command" ],
          "Properties": {
              "AvailabilityZone" : { "Ref" : "AvailabilityZone" },
              "BlockDeviceMappings" : [
                  {
                       "DeviceName" : "/dev/sda1",
                       "Ebs" : {
                       "VolumeSize" : "30"
                       }
                  }
              ],
              "ImageId": {
                  "Ref": "ContrailAMI"
              },
              "InstanceType": {
                  "Ref": "ControllerInstanceType"
              },
              "KeyName": {
                  "Ref": "KeyName"
              },
              "NetworkInterfaces" : [ {
                "NetworkInterfaceId" : {"Ref" : "Eth0Command" },
                "DeviceIndex" : "0"
                },
                {
                  "NetworkInterfaceId" : {"Ref" : "Eth1Command" },
                  "DeviceIndex" : "1"
                  }],
              "Tags": [
                  {
                      "Key": "Name",
                      "Value": { "Fn::Join" : [ ".", [ "OneClick Contrail Command Instance", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                  }
              ],
              "UserData": {
                  "Fn::Base64": {
                    "Fn::Join": [
                        "",
                        [
                          "#!/bin/bash -x\n",
                          "exec > /tmp/part-001.log 2>&1\n",
                          "echo 'root:", {"Ref": "SSHPassword"}, "' | chpasswd\n",
                          "yum install -y iptables-services\n",
                          "systemctl start iptables\n",
                          "systemctl enable iptables\n",
                          "iptables -t nat -I PREROUTING -p tcp -d ", {"Ref": "ContrailCommandPublicIP"}, " --dport 1139 -j DNAT --to-destination ", {"Ref": "ContrailControllerPrivateIP"}, ":22\n",
                          "iptables -t nat -I POSTROUTING -p tcp -d ", {"Ref": "ContrailControllerPrivateIP"}, " --dport 22 -j SNAT --to-source ", {"Ref": "ContrailCommandPrivateIP"}, "\n",
                          "iptables -I FORWARD -p tcp -d ", {"Ref": "ContrailControllerPrivateIP"}, " --dport 22 -j ACCEPT\n",
                          "iptables -I FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT\n",
                          "iptables -t nat -I PREROUTING -p tcp -d ", {"Ref": "ContrailCommandPublicIP"}, " --dport 8143 -j DNAT --to-destination ", {"Ref": "ContrailControllerPrivateIP"}, ":8143\n",
                          "iptables -t nat -I POSTROUTING -p tcp -d ", {"Ref": "ContrailControllerPrivateIP"}, " --dport 8143 -j SNAT --to-source ", {"Ref": "ContrailCommandPrivateIP"}, "\n",
                          "iptables -I FORWARD -p tcp -d ", {"Ref": "ContrailControllerPrivateIP"}, " --dport 8143 -j ACCEPT\n",
                          "iptables -t nat -I PREROUTING -p tcp -d  ", {"Ref": "ContrailCommandPublicIP"}, " --dport 2140 -j DNAT --to-destination ", {"Ref": "k8minion11PrivateIP"}, ":22\n",
                          "iptables -t nat -I POSTROUTING -p tcp -d ", {"Ref": "k8minion11PrivateIP"}, " --dport 22 -j SNAT --to-source ", {"Ref": "ContrailCommandPrivateIP"}, "\n",
                          "iptables -I FORWARD -p tcp -d ", {"Ref": "k8minion11PrivateIP"}, " --dport 22 -j ACCEPT\n",
                          "iptables -t nat -I PREROUTING -p tcp -d ", {"Ref": "ContrailCommandPublicIP"}, " --dport 2138 -j DNAT --to-destination ", {"Ref": "MCGW11PrivateIP"}, ":22\n",
                          "iptables -t nat -I POSTROUTING -p tcp -d ", {"Ref": "MCGW11PrivateIP"}, " --dport 22 -j SNAT --to-source  ", {"Ref": "ContrailCommandPrivateIP"}, "\n",
                          "iptables -I FORWARD -p tcp -d ", {"Ref": "MCGW11PrivateIP"}, " --dport 22 -j ACCEPT\n",
                          "iptables -t nat -I PREROUTING -p tcp -d ", {"Ref": "ContrailCommandPublicIP"}, " --dport 3140 -j DNAT --to-destination ", {"Ref": "k8minion21PrivateIP"}, ":22\n",
                          "iptables -t nat -I POSTROUTING -p tcp -d ", {"Ref": "k8minion21PrivateIP"}, " --dport 22 -j SNAT --to-source ", {"Ref": "ContrailCommandPrivateIP"}, "\n",
                          "iptables -I FORWARD -p tcp -d ", {"Ref": "k8minion21PrivateIP"}, " --dport 22 -j ACCEPT\n",
                          "iptables -t nat -I PREROUTING -p tcp -d ", {"Ref": "ContrailCommandPublicIP"}, " --dport 3138 -j DNAT --to-destination ", {"Ref": "MCGW21PrivateIP"}, ":22\n",
                          "iptables -t nat -I POSTROUTING -p tcp -d ", {"Ref": "MCGW21PrivateIP"}, " --dport 22 -j SNAT --to-source ", {"Ref": "ContrailCommandPrivateIP"}, "\n",
                          "iptables -I FORWARD -p tcp -d ", {"Ref": "MCGW21PrivateIP"}, " --dport 22 -j ACCEPT\n",
                          "iptables -I INPUT -p tcp -m tcp --dport 9091 -j ACCEPT\n",
                          "service iptables save\n",
                          "yum install -y yum-utils device-mapper-persistent-data lvm2\n",
                          "yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\n",
                          "yum install -y docker-ce-18.03.1.ce\n",
                          "systemctl start docker\n",
                          "systemctl status docker\n",
                          "systemctl enable docker\n",
                          "docker login hub.juniper.net --username ", {"Ref": "ContainerRegistryUserName"}, " --password ", {"Ref": "ContainerRegistryPassword"}, "\n",
                          "docker pull hub.juniper.net/contrail/contrail-command-deployer:5.1.0-0.38\n",
                          "sed -i \"s/PasswordAuthentication no/PasswordAuthentication yes/g\" /etc/ssh/sshd_config\n",
                          "echo \"\nPermitRootLogin yes\" | tee --append /etc/ssh/sshd_config\n",
                          "ssh-keygen -b 2048 -t rsa -f /root/.ssh/id_rsa -q -N \"\"\n",
                          "cat /root/.ssh/id_rsa.pub | tee --append /root/.ssh/authorized_keys\n",
                          "chmod 0600 /root/.ssh/id_rsa*\n",
                          "systemctl restart sshd.service\n",
                          "echo \"GATEWAYDEV=ens3\" >> /etc/sysconfig/network\n",
                          "echo \"network:\" >> /etc/cloud/cloud.cfg\n",
                          "echo \"  config: disabled\" >> /etc/cloud/cloud.cfg\n",
                          "echo \"BOOTPROTO=dhcp\" | tee /etc/sysconfig/network-scripts/ifcfg-ens4\n",
                          "echo \"DEVICE=ens4\" | tee --append /etc/sysconfig/network-scripts/ifcfg-ens4\n",
                          "echo \"ONBOOT=yes\" | tee --append /etc/sysconfig/network-scripts/ifcfg-ens4\n",
                          "echo \"TYPE=Ethernet\" | tee --append /etc/sysconfig/network-scripts/ifcfg-ens4\n",
                          "echo \"USERCTL=no\" | tee --append /etc/sysconfig/network-scripts/ifcfg-ens4\n",
                          "rm -f /etc/sysconfig/network-scripts/ifcfg-eth0\n",
                          "rm -f /var/run/dhclient*\n",
                          "echo \"", {"Ref": "VPCCIDR2"}, " via ", {"Ref": "PrivateSubnetGatewayIP"}, " dev ens4\" | tee --append /etc/sysconfig/network-scripts/route-ens4\n",
                          "echo \"", {"Ref": "VPCCIDR3"}, " via ", {"Ref": "PrivateSubnetGatewayIP"}, " dev ens4\" | tee --append /etc/sysconfig/network-scripts/route-ens4\n",
                          "systemctl restart network.service\n",
                          "echo \"command_servers:\" | tee /tmp/command_servers.yml\n",
                          "echo \"    server1:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"        ip: ", {"Ref": "ContrailCommandPrivateIP"}, "\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"        connection: ssh\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"        ssh_user: root\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"        ssh_pass: ", {"Ref": "SSHPassword"},  "\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"        sudo_pass: ", {"Ref": "SSHPassword"}, "\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"        ntpserver: 17.253.34.253\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"        registry_insecure: false\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"        container_registry: hub.juniper.net/contrail\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"        container_tag: ", {"Ref": "ContainerRegistryTag"}, "\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"        container_registry_username: ", {"Ref": "ContainerRegistryUserName"}, "\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"        container_registry_password: ", {"Ref": "ContainerRegistryPassword"}, "\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"        config_dir: /etc/contrail\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"        contrail_config:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"            database:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              type: postgres\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              dialect: postgres\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              host: localhost\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              user: root\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              password: ", {"Ref": "ContrailPassword"}, "\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              name: contrail_test\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              max_open_conn: 100\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              connection_retries: 10\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              retry_period: 3s\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"            log_level: debug\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"            cache:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                enabled: true\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                timeout: 10s\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                max_history: 100000\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                rdbms:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                  enabled: true\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"            server:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                enabled: true\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                read_timeout: 10\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                write_timeout: 5\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                log_api: true\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                address: :9091\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                tls:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                  enabled: true\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                  key_file: /usr/share/contrail/ssl/cs-key.pem\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                  cert_file: /usr/share/contrail/ssl/cs-cert.pem\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                enable_grpc: false\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                static_files:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                  /: /usr/share/contrail/public\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                notify_etcd: false\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                enable_vnc_replication: true\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"            keystone:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                local: true\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                assignment:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                  type: static\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                  data:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                     domains:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                        default: &default\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                          id: default\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                          name: default\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                     projects:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                        admin: &admin\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                          id: admin\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                          name: admin\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                          domain: *default\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                        demo: &demo\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                          id: demo\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                          name: demo\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                          domain: *default\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                     users:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                        admin:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                          id: admin\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                          name: admin\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                          domain: *default\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                          password: ", {"Ref": "ContrailPassword"}, "\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                          email: sgreen@juniper.net\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                          roles:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                          - id: admin\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                            name: admin\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                            project: *admin\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                store:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                  type: memory\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                  expire: 36000\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                  insecure: true\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                  authurl: https://localhost:9091/keystone/v3\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"            insecure: true\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"            auth_type: basic-auth\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"            etcd:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                endpoints:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                 - localhost:2379\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                username: \" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                password: \" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                path: contrail\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"            watcher:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                enabled: false\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"                storage: json\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"            client:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              id: admin\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              password: ", {"Ref": "ContrailPassword"}, "\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              project_name: admin\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              domain_id: default\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              schema_root: /\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              endpoint: https://localhost:9091\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"            agent:\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              enabled: true\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              backend: file\" | tee --append /tmp/command_servers.yml\n",
                          "echo \"              log_level: debug\" | tee --append /tmp/command_servers.yml\n",
                          "docker run -td --net host -v /tmp/command_servers.yml:/command_servers.yml --privileged --name contrail_command_deployer hub.juniper.net/contrail/contrail-command-deployer:", {"Ref": "ContainerRegistryTag"}, "\n",
                          "service iptables save\n",
                          "echo \"all done, ansible will take a few minutes to complete, then connect to the Contrail Command UI on https://",
                          {"Ref": "IPAddress"},
                          ":9091\"\n"
                        ]
                    ]
                  }
              }
            }
        },
        "Eth0Command" : {
          "Type" : "AWS::EC2::NetworkInterface",
          "Properties" : {
            "Description"     : "eth0",
            "GroupSet"        : [ { "Ref" : "SecurityGroupContrailCommand" } ],
            "PrivateIpAddress" : { "Ref" : "ContrailCommandPublicIP" },
            "SourceDestCheck" : "false",
            "SubnetId"        : { "Ref" : "PublicSubnet" },
            "Tags"            : [ {"Key" : "Name", "Value" : "Interface 0"}, {"Key" : "Interface", "Value" : "eth0"} ]
          }
        },
        "Eth1Command" : {
          "Type" : "AWS::EC2::NetworkInterface",
          "Properties" : {
            "Description"     : "eth1",
            "GroupSet"        : [ { "Ref" : "SecurityGroupContrailCommand" } ],
            "PrivateIpAddress" : { "Ref" : "ContrailCommandPrivateIP" },
            "SourceDestCheck" : "false",
            "SubnetId"        : { "Ref" : "PrivateSubnet" },
            "Tags"            : [ {"Key" : "Name", "Value" : "Interface 1"}, {"Key" : "Interface", "Value" : "eth1"} ]
            }
        },
        "ContrailControllerInstance": {
          "Type": "AWS::EC2::Instance",
          "DependsOn": [ "PrivateSubnet", "Eth0Controller" ],
          "Properties": {
              "AvailabilityZone" : { "Ref" : "AvailabilityZone" },
              "BlockDeviceMappings" : [
                  {
                       "DeviceName" : "/dev/sda1",
                       "Ebs" : {
                       "VolumeSize" : "300"
                       }
                  }
              ],
              "ImageId": {
                  "Ref": "ContrailAMI"
              },
              "InstanceType": {
                  "Ref": "ControllerInstanceType"
              },
              "KeyName": {
                  "Ref": "KeyName"
              },
              "NetworkInterfaces" : [ {
                "NetworkInterfaceId" : {"Ref" : "Eth0Controller" },
                "DeviceIndex" : "0"
                }],
              "Tags": [
                  {
                      "Key": "Name",
                      "Value": { "Fn::Join" : [ ".", [ "OneClick Contrail Controller and K8S Master Instance", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                  }
              ],
              "UserData": {
                  "Fn::Base64": {
                    "Fn::Join": [
                        "",
                        [
                          "#!/bin/bash -x\n",
                          "exec > /tmp/part-001.log 2>&1\n",
                          "echo 'root:", {"Ref": "SSHPassword"}, "' | chpasswd\n",
                          "sed -i \"s/PasswordAuthentication no/PasswordAuthentication yes/g\" /etc/ssh/sshd_config\n",
                          "echo \"\nPermitRootLogin yes\" | tee --append /etc/ssh/sshd_config\n",
                          "ssh-keygen -b 2048 -t rsa -f /root/.ssh/id_rsa -q -N \"\"\n",
                          "cat /root/.ssh/id_rsa.pub | tee --append /root/.ssh/authorized_keys\n",
                          "chmod 0600 /root/.ssh/id_rsa*\n",
                          "systemctl restart sshd.service\n",
                          "yum install -y yum-utils device-mapper-persistent-data lvm2\n", 
                          "yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\n", 
                          "yum install -y bind-utils\n", 
                          "yum install -y ntp\n", 
                          "systemctl start ntpd\n", 
                          "systemctl enable ntpd\n",
                          "rm -f /etc/sysconfig/network-scripts/ifcfg-eth0\n",
                          "rm -f /var/run/dhclient*\n",
                          "systemctl restart network.service\n"
                        ]
                    ]
                  }
              }
            }
        },
        "Eth0Controller" : {
          "Type" : "AWS::EC2::NetworkInterface",
          "Properties" : {
            "Description"     : "eth0Controller",
            "GroupSet"        : [ { "Ref" : "SecurityGroupContrailVPC1" } ],
            "PrivateIpAddress" : { "Ref" : "ContrailControllerPrivateIP" },
            "SourceDestCheck" : "false",
            "SubnetId"        : { "Ref" : "PrivateSubnet" },
            "Tags"            : [ {"Key" : "Name", "Value" : "Interface 0"}, {"Key" : "Interface", "Value" : "eth0"} ]
          }
        },
        "k8minionInstance11": {
          "Type": "AWS::EC2::Instance",
          "DependsOn": [ "PrivateSubnet2", "Eth0k8minion11" ],
          "Properties": {
              "AvailabilityZone" : { "Ref" : "AvailabilityZone" },
              "BlockDeviceMappings" : [
                  {
                       "DeviceName" : "/dev/sda1",
                       "Ebs" : {
                       "VolumeSize" : "100"
                       }
                  }
              ],
              "ImageId": {
                  "Ref": "ContrailAMI"
              },
              "InstanceType": {
                  "Ref": "k8minionInstanceType"
              },
              "KeyName": {
                  "Ref": "KeyName"
              },
              "NetworkInterfaces" : [ {
                "NetworkInterfaceId" : {"Ref" : "Eth0k8minion11" },
                "DeviceIndex" : "0"
                }],
              "Tags": [
                  {
                      "Key": "Name",
                      "Value": { "Fn::Join" : [ ".", [ "OneClick k8minion11", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                  }
              ],
              "UserData": {
                  "Fn::Base64": {
                    "Fn::Join": [
                        "",
                        [
                          "#!/bin/bash -x\n",
                          "exec > /tmp/part-001.log 2>&1\n",
                          "echo 'root:", {"Ref": "SSHPassword"}, "' | chpasswd\n",
                          "sed -i \"s/PasswordAuthentication no/PasswordAuthentication yes/g\" /etc/ssh/sshd_config\n",
                          "echo \"\nPermitRootLogin yes\" | tee --append /etc/ssh/sshd_config\n",
                          "ssh-keygen -b 2048 -t rsa -f /root/.ssh/id_rsa -q -N \"\"\n",
                          "cat /root/.ssh/id_rsa.pub | tee --append /root/.ssh/authorized_keys\n",
                          "chmod 0600 /root/.ssh/id_rsa*\n",
                          "systemctl restart sshd.service\n",
                          "yum install -y yum-utils device-mapper-persistent-data lvm2\n", 
                          "yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\n", 
                          "yum install -y bind-utils\n", 
                          "yum install -y ntp\n", 
                          "systemctl start ntpd\n", 
                          "systemctl enable ntpd\n",
                          "rm -f /etc/sysconfig/network-scripts/ifcfg-eth0\n",
                          "rm -f /var/run/dhclient*\n",
                          "systemctl restart network.service\n"
                        ]
                    ]
                  }
              }
            }
        },
        "Eth0k8minion11" : {
          "Type" : "AWS::EC2::NetworkInterface",
          "Properties" : {
            "Description"     : "eth0k8minion11",
            "GroupSet"        : [ { "Ref" : "SecurityGroupContrailVPC2" } ],
            "PrivateIpAddress" : { "Ref" : "k8minion11PrivateIP" },
            "SourceDestCheck" : "false",
            "SubnetId"        : { "Ref" : "PrivateSubnet2" },
            "Tags"            : [ {"Key" : "Name", "Value" : "Interface 0"}, {"Key" : "Interface", "Value" : "eth0"} ]
          }
        },
        "k8minionInstance21": {
          "Type": "AWS::EC2::Instance",
          "DependsOn": [ "PrivateSubnet3", "Eth0k8minion21" ],
          "Properties": {
              "AvailabilityZone" : { "Ref" : "AvailabilityZone2" },
              "BlockDeviceMappings" : [
                  {
                       "DeviceName" : "/dev/sda1",
                       "Ebs" : {
                       "VolumeSize" : "100"
                       }
                  }
              ],
              "ImageId": {
                  "Ref": "ContrailAMI"
              },
              "InstanceType": {
                  "Ref": "k8minionInstanceType"
              },
              "KeyName": {
                  "Ref": "KeyName"
              },
              "NetworkInterfaces" : [ {
                "NetworkInterfaceId" : {"Ref" : "Eth0k8minion21" },
                "DeviceIndex" : "0"
                }],
              "Tags": [
                  {
                      "Key": "Name",
                      "Value": { "Fn::Join" : [ ".", [ "OneClick k8minion21", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                  }
              ],
              "UserData": {
                  "Fn::Base64": {
                    "Fn::Join": [
                        "",
                        [
                          "#!/bin/bash -x\n",
                          "exec > /tmp/part-001.log 2>&1\n",
                          "echo 'root:", {"Ref": "SSHPassword"}, "' | chpasswd\n",
                          "sed -i \"s/PasswordAuthentication no/PasswordAuthentication yes/g\" /etc/ssh/sshd_config\n",
                          "echo \"\nPermitRootLogin yes\" | tee --append /etc/ssh/sshd_config\n",
                          "ssh-keygen -b 2048 -t rsa -f /root/.ssh/id_rsa -q -N \"\"\n",
                          "cat /root/.ssh/id_rsa.pub | tee --append /root/.ssh/authorized_keys\n",
                          "chmod 0600 /root/.ssh/id_rsa*\n",
                          "systemctl restart sshd.service\n",
                          "yum install -y yum-utils device-mapper-persistent-data lvm2\n", 
                          "yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\n", 
                          "yum install -y bind-utils\n", 
                          "yum install -y ntp\n", 
                          "systemctl start ntpd\n", 
                          "systemctl enable ntpd\n",
                          "rm -f /etc/sysconfig/network-scripts/ifcfg-eth0\n",
                          "rm -f /var/run/dhclient*\n",
                          "systemctl restart network.service\n"
                        ]
                    ]
                  }
              }
            }
        },
        "Eth0k8minion21" : {
          "Type" : "AWS::EC2::NetworkInterface",
          "Properties" : {
            "Description"     : "eth0k8minion21",
            "GroupSet"        : [ { "Ref" : "SecurityGroupContrailVPC3" } ],
            "PrivateIpAddress" : { "Ref" : "k8minion21PrivateIP" },
            "SourceDestCheck" : "false",
            "SubnetId"        : { "Ref" : "PrivateSubnet3" },
            "Tags"            : [ {"Key" : "Name", "Value" : "Interface 0"}, {"Key" : "Interface", "Value" : "eth0"} ]
          }
        },


        "MCGWInstance11": {
          "Type": "AWS::EC2::Instance",
          "DependsOn": [ "IPAddress2", "PrivateSubnet2", "Eth0MCGW11", "Eth1MCGW11" ],
          "Properties": {
              "AvailabilityZone" : { "Ref" : "AvailabilityZone" },
              "BlockDeviceMappings" : [
                  {
                       "DeviceName" : "/dev/sda1",
                       "Ebs" : {
                       "VolumeSize" : "50"
                       }
                  }
              ],
              "ImageId": {
                  "Ref": "ContrailAMI"
              },
              "InstanceType": {
                  "Ref": "ControllerInstanceType"
              },
              "KeyName": {
                  "Ref": "KeyName"
              },
              "NetworkInterfaces" : [ {
                "NetworkInterfaceId" : {"Ref" : "Eth0MCGW11" },
                "DeviceIndex" : "0"
                },
                {
                  "NetworkInterfaceId" : {"Ref" : "Eth1MCGW11" },
                  "DeviceIndex" : "1"
                  }],
              "Tags": [
                  {
                      "Key": "Name",
                      "Value": { "Fn::Join" : [ ".", [ "OneClick MCGW11 Instance", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                  }
              ],
              "UserData": {
                  "Fn::Base64": {
                    "Fn::Join": [
                        "",
                        [
                          "#!/bin/bash -x\n",
                          "exec > /tmp/part-001.log 2>&1\n",
                          "echo 'root:", {"Ref": "SSHPassword"}, "' | chpasswd\n",
                          "sed -i \"s/PasswordAuthentication no/PasswordAuthentication yes/g\" /etc/ssh/sshd_config\n",
                          "echo \"\nPermitRootLogin yes\" | tee --append /etc/ssh/sshd_config\n",
                          "ssh-keygen -b 2048 -t rsa -f /root/.ssh/id_rsa -q -N \"\"\n",
                          "cat /root/.ssh/id_rsa.pub | tee --append /root/.ssh/authorized_keys\n",
                          "chmod 0600 /root/.ssh/id_rsa*\n",
                          "systemctl restart sshd.service\n",
                          "yum install -y yum-utils device-mapper-persistent-data lvm2\n", 
                          "yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\n", 
                          "yum install -y bind-utils\n", 
                          "yum install -y ntp\n", 
                          "systemctl start ntpd\n", 
                          "systemctl enable ntpd\n",
                          "rm -f /etc/sysconfig/network-scripts/ifcfg-eth0\n",
                          "rm -f /var/run/dhclient*\n",
                          "echo \"BOOTPROTO=dhcp\" | tee /etc/sysconfig/network-scripts/ifcfg-ens4\n",
                          "echo \"DEVICE=ens4\" | tee --append /etc/sysconfig/network-scripts/ifcfg-ens4\n",
                          "echo \"ONBOOT=yes\" | tee --append /etc/sysconfig/network-scripts/ifcfg-ens4\n",
                          "echo \"TYPE=Ethernet\" | tee --append /etc/sysconfig/network-scripts/ifcfg-ens4\n",
                          "echo \"USERCTL=no\" | tee --append /etc/sysconfig/network-scripts/ifcfg-ens4\n",
                          "echo \"", {"Ref": "VPCCIDR"}, " via ", {"Ref": "PrivateSubnetGatewayIP2"}, " dev ens4\" | tee --append /etc/sysconfig/network-scripts/route-ens4\n",
                          "echo \"", {"Ref": "VPCCIDR3"}, " via ", {"Ref": "PrivateSubnetGatewayIP2"}, " dev ens4\" | tee --append /etc/sysconfig/network-scripts/route-ens4\n",
                          "echo \"net.ipv4.ip_forward = 1\" | tee --append /etc/sysctl.conf\n",
                          "echo 1 > /proc/sys/net/ipv4/ip_forward\n",
                          "echo \"GATEWAYDEV=ens3\" >> /etc/sysconfig/network\n",
                          "systemctl restart network.service\n",
                          "yum install -y iptables-services\n",
                          "systemctl start iptables\n",
                          "systemctl enable iptables\n",
                          "iptables -t nat -A POSTROUTING -o ens3 -j MASQUERADE\n",
                          "iptables -A FORWARD -i ens4 -o ens3 -m state --state RELATED,ESTABLISHED -j ACCEPT\n",
                          "iptables -A FORWARD -i ens3 -o ens4 -j ACCEPT\n",
                          "iptables -D INPUT -j REJECT --reject-with icmp-host-prohibited\n",
                          "iptables -D FORWARD -j REJECT --reject-with icmp-host-prohibited\n",
                          "service iptables save\n"
                        ]
                    ]
                  }
                }
            }
        },
        "Eth0MCGW11" : {
          "Type" : "AWS::EC2::NetworkInterface",
          "Properties" : {
            "Description"     : "eth0",
            "GroupSet"        : [ { "Ref" : "SecurityGroupContrailVPC2" } ],
            "PrivateIpAddress" : { "Ref" : "MCGW11PublicIP" },
            "SourceDestCheck" : "false",
            "SubnetId"        : { "Ref" : "PublicSubnet2" },
            "Tags"            : [ {"Key" : "Name", "Value" : "Interface 0"}, {"Key" : "Interface", "Value" : "eth0"} ]
          }
        },
        "Eth1MCGW11" : {
          "Type" : "AWS::EC2::NetworkInterface",
          "Properties" : {
            "Description"     : "eth1",
            "GroupSet"        : [ { "Ref" : "SecurityGroupContrailVPC2" } ],
            "PrivateIpAddress" : { "Ref" : "MCGW11PrivateIP" },
            "SourceDestCheck" : "false",
            "SubnetId"        : { "Ref" : "PrivateSubnet2" },
            "Tags"            : [ {"Key" : "Name", "Value" : "Interface 1"}, {"Key" : "Interface", "Value" : "eth1"} ]
            }
        },
        "MCGWInstance21": {
          "Type": "AWS::EC2::Instance",
          "DependsOn": [ "IPAddress2", "PrivateSubnet3", "Eth0MCGW21", "Eth1MCGW21" ],
          "Properties": {
              "AvailabilityZone" : { "Ref" : "AvailabilityZone2" },
              "BlockDeviceMappings" : [
                  {
                       "DeviceName" : "/dev/sda1",
                       "Ebs" : {
                       "VolumeSize" : "50"
                       }
                  }
              ],
              "ImageId": {
                  "Ref": "ContrailAMI"
              },
              "InstanceType": {
                  "Ref": "ControllerInstanceType"
              },
              "KeyName": {
                  "Ref": "KeyName"
              },
              "NetworkInterfaces" : [ {
                "NetworkInterfaceId" : {"Ref" : "Eth0MCGW21" },
                "DeviceIndex" : "0"
                },
                {
                  "NetworkInterfaceId" : {"Ref" : "Eth1MCGW21" },
                  "DeviceIndex" : "1"
                  }],
              "Tags": [
                  {
                      "Key": "Name",
                      "Value": { "Fn::Join" : [ ".", [ "OneClick MCGW21 Instance", { "Ref" : "SiteName" }, { "Ref" : "AvailabilityZone" } ] ] }
                  }
              ],
              "UserData": {
                  "Fn::Base64": {
                    "Fn::Join": [
                        "",
                        [
                          "#!/bin/bash -x\n",
                          "exec > /tmp/part-001.log 2>&1\n",
                          "echo 'root:", {"Ref": "SSHPassword"}, "' | chpasswd\n",
                          "sed -i \"s/PasswordAuthentication no/PasswordAuthentication yes/g\" /etc/ssh/sshd_config\n",
                          "echo \"\nPermitRootLogin yes\" | tee --append /etc/ssh/sshd_config\n",
                          "ssh-keygen -b 2048 -t rsa -f /root/.ssh/id_rsa -q -N \"\"\n",
                          "cat /root/.ssh/id_rsa.pub | tee --append /root/.ssh/authorized_keys\n",
                          "chmod 0600 /root/.ssh/id_rsa*\n",
                          "systemctl restart sshd.service\n",
                          "yum install -y yum-utils device-mapper-persistent-data lvm2\n", 
                          "yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\n", 
                          "yum install -y bind-utils\n", 
                          "yum install -y ntp\n", 
                          "systemctl start ntpd\n", 
                          "systemctl enable ntpd\n",
                          "rm -f /etc/sysconfig/network-scripts/ifcfg-eth0\n",
                          "rm -f /var/run/dhclient*\n",
                          "echo \"BOOTPROTO=dhcp\" | tee /etc/sysconfig/network-scripts/ifcfg-ens4\n",
                          "echo \"DEVICE=ens4\" | tee --append /etc/sysconfig/network-scripts/ifcfg-ens4\n",
                          "echo \"ONBOOT=yes\" | tee --append /etc/sysconfig/network-scripts/ifcfg-ens4\n",
                          "echo \"TYPE=Ethernet\" | tee --append /etc/sysconfig/network-scripts/ifcfg-ens4\n",
                          "echo \"USERCTL=no\" | tee --append /etc/sysconfig/network-scripts/ifcfg-ens4\n",
                          "echo \"", {"Ref": "VPCCIDR"}, " via ", {"Ref": "PrivateSubnetGatewayIP3"}, " dev ens4\" | tee --append /etc/sysconfig/network-scripts/route-ens4\n",
                          "echo \"", {"Ref": "VPCCIDR2"}, " via ", {"Ref": "PrivateSubnetGatewayIP3"}, " dev ens4\" | tee --append /etc/sysconfig/network-scripts/route-ens4\n",
                          "echo \"net.ipv4.ip_forward = 1\" | tee --append /etc/sysctl.conf\n",
                          "echo 1 > /proc/sys/net/ipv4/ip_forward\n",
                          "echo \"GATEWAYDEV=ens3\" >> /etc/sysconfig/network\n",
                          "systemctl restart network.service\n",
                          "yum install -y iptables-services\n",
                          "systemctl start iptables\n",
                          "systemctl enable iptables\n",
                          "iptables -t nat -A POSTROUTING -o ens3 -j MASQUERADE\n",
                          "iptables -A FORWARD -i ens4 -o ens3 -m state --state RELATED,ESTABLISHED -j ACCEPT\n",
                          "iptables -A FORWARD -i ens3 -o ens4 -j ACCEPT\n",
                          "iptables -D INPUT -j REJECT --reject-with icmp-host-prohibited\n",
                          "iptables -D FORWARD -j REJECT --reject-with icmp-host-prohibited\n",
                          "service iptables save\n"
                        ]
                    ]
                  }
                }
            }
        },
        "Eth0MCGW21" : {
          "Type" : "AWS::EC2::NetworkInterface",
          "Properties" : {
            "Description"     : "eth0",
            "SourceDestCheck" : "false",
            "GroupSet"        : [ { "Ref" : "SecurityGroupContrailVPC3" } ],
            "PrivateIpAddress" : { "Ref" : "MCGW21PublicIP" },
            "SubnetId"        : { "Ref" : "PublicSubnet3" },
            "Tags"            : [ {"Key" : "Name", "Value" : "Interface 0"}, {"Key" : "Interface", "Value" : "eth0"} ]
          }
        },
        "Eth1MCGW21" : {
          "Type" : "AWS::EC2::NetworkInterface",
          "Properties" : {
            "Description"     : "eth1",
            "SourceDestCheck" : "false",
            "GroupSet"        : [ { "Ref" : "SecurityGroupContrailVPC3" } ],
            "PrivateIpAddress" : { "Ref" : "MCGW21PrivateIP" },
            "SubnetId"        : { "Ref" : "PrivateSubnet3" },
            "Tags"            : [ {"Key" : "Name", "Value" : "Interface 1"}, {"Key" : "Interface", "Value" : "eth1"} ]
            }
        },
        "IPAssociaton": {
            "Type": "AWS::EC2::EIPAssociation",
            "DependsOn": "ContrailCommandInstance",
            "Properties": {
                "NetworkInterfaceId" : { "Ref" : "Eth0Command" },
                "AllocationId": {
                    "Fn::GetAtt": [
                        "IPAddress",
                        "AllocationId"
                    ]
                }
            }
        },
        "IPAssociaton2": {
            "Type": "AWS::EC2::EIPAssociation",
            "DependsOn": "MCGWInstance11",
            "Properties": {
                "NetworkInterfaceId" : { "Ref" : "Eth0MCGW11" },
                "AllocationId": {
                    "Fn::GetAtt": [
                        "IPAddress2",
                        "AllocationId"
                    ]
                }
            }
        },
        "IPAssociaton3": {
            "Type": "AWS::EC2::EIPAssociation",
            "DependsOn": "MCGWInstance21",
            "Properties": {
                "NetworkInterfaceId" : { "Ref" : "Eth0MCGW21" },
                "AllocationId": {
                    "Fn::GetAtt": [
                        "IPAddress3",
                        "AllocationId"
                    ]
                }
            }
        },
        "PeeringRouteFromVPC1PrivateToVPC2Private": {
             "Type": "AWS::EC2::Route",
             "Properties": {
                 "DestinationCidrBlock": {"Ref": "PrivateSubnetCIDR2"},
                 "RouteTableId": {"Ref": "PrivateSubnetRouteTable"},
                 "VpcPeeringConnectionId": {
                     "Ref": "VPCPeeringConnectionVPC1ToVPC2"
                 }
             }
         },
         "PeeringRouteFromVPC2PrivateToVPC1Private": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "DestinationCidrBlock": {"Ref": "PrivateSubnetCIDR"},
                "RouteTableId": {"Ref": "PrivateSubnetRouteTable2"},
                "VpcPeeringConnectionId": {
                    "Ref": "VPCPeeringConnectionVPC1ToVPC2"
                }
             }
          },
          "VPCPeeringConnectionVPC1ToVPC2": {
              "Type": "AWS::EC2::VPCPeeringConnection",
              "Properties": {
                  "VpcId": {"Ref": "VPC"},
                  "PeerVpcId": {"Ref": "VPC2"},
                  "Tags": [
                      {
                          "Key": "Name",
                          "Value": "VCP peering connection VPC1 to VPC2"
                      },
                      {
                          "Key": "CloudFormationStack",
                          "Value": {
                              "Ref": "AWS::StackId"
                          }
                      }
                  ]
              }
         },
        "PeeringRouteFromVPC1PrivateToVPC3Private": {
             "Type": "AWS::EC2::Route",
             "Properties": {
                 "DestinationCidrBlock": {"Ref": "PrivateSubnetCIDR3"},
                 "RouteTableId": {"Ref": "PrivateSubnetRouteTable"},
                 "VpcPeeringConnectionId": {
                     "Ref": "VPCPeeringConnectionVPC1ToVPC3"
                 }
             }
         },
         "PeeringRouteFromVPC3PrivateToVPC1Private": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "DestinationCidrBlock": {"Ref": "PrivateSubnetCIDR"},
                "RouteTableId": {"Ref": "PrivateSubnetRouteTable3"},
                "VpcPeeringConnectionId": {
                    "Ref": "VPCPeeringConnectionVPC1ToVPC3"
                }
             }
          },
          "VPCPeeringConnectionVPC1ToVPC3": {
              "Type": "AWS::EC2::VPCPeeringConnection",
              "Properties": {
                  "VpcId": {"Ref": "VPC"},
                  "PeerVpcId": {"Ref": "VPC3"},
                  "Tags": [
                      {
                          "Key": "Name",
                          "Value": "VCP peering connection VPC1 to VPC3"
                      },
                      {
                          "Key": "CloudFormationStack",
                          "Value": {
                              "Ref": "AWS::StackId"
                          }
                      }
                  ]
              }
        },
        "PeeringRouteFromVPC2PrivateToVPC3Private": {
             "Type": "AWS::EC2::Route",
             "Properties": {
                 "DestinationCidrBlock": {"Ref": "PrivateSubnetCIDR3"},
                 "RouteTableId": {"Ref": "PrivateSubnetRouteTable2"},
                 "VpcPeeringConnectionId": {
                     "Ref": "VPCPeeringConnectionVPC2ToVPC3"
                 }
             }
         },
         "PeeringRouteFromVPC3PrivateToVPC2Private": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "DestinationCidrBlock": {"Ref": "PrivateSubnetCIDR2"},
                "RouteTableId": {"Ref": "PrivateSubnetRouteTable3"},
                "VpcPeeringConnectionId": {
                    "Ref": "VPCPeeringConnectionVPC2ToVPC3"
                }
             }
          },
          "VPCPeeringConnectionVPC2ToVPC3": {
              "Type": "AWS::EC2::VPCPeeringConnection",
              "Properties": {
                  "VpcId": {"Ref": "VPC2"},
                  "PeerVpcId": {"Ref": "VPC3"},
                  "Tags": [
                      {
                          "Key": "Name",
                          "Value": "VCP peering connection VPC2 to VPC3"
                      },
                      {
                          "Key": "CloudFormationStack",
                          "Value": {
                              "Ref": "AWS::StackId"
                          }
                      }
                  ]
              }
         }
    },
    "Outputs" : {
           "ContrailCommandWebUI": {
                   "Description": "Contrail Command Web UI",
                   "Value":  { "Fn::Join": [ "", [ "https://", {"Ref": "IPAddress"}, ":9091" ] ] }
                   
           },
           "ContrailUI": {
                   "Description": "Contrail Web UI",
                   "Value": { "Fn::Join": [ "", [ "https://", {"Ref": "IPAddress"}, ":8143" ] ] }
           },
           "ContrailCommandPublicIP": {
                   "Description": "Contrail Command Public IP",
                   "Value": {
                               "Ref": "IPAddress"
                       }
           },
           "MCGW11PublicIP": {
                   "Description": "MCGW1-1 Public IP",
                   "Value": {
                               "Ref": "IPAddress2"
                       }
           },
           "MCGW21PublicIP": {
                   "Description": "MCGW2-1 Public IP",
                   "Value": {
                               "Ref": "IPAddress3"
                       }
           },
           "ContrailBareMetalControllerPrivateIP": {
                   "Description": "Contrail Controller and k8master Private IP",
                   "Value": {
                               "Ref": "ContrailControllerPrivateIP"
                       }
           },
           "k8minion11PrivateIP": {
                   "Description": "k8minion1-1 Private IP",
                   "Value": {
                               "Ref": "k8minion11PrivateIP"
                       }
           },
           "k8minion21PrivateIP": {
                   "Description": "k8minion2-1 Private IP",
                   "Value": {
                               "Ref": "k8minion21PrivateIP"
                       }
           },
           "MCGW11PrivateIP": {
                   "Description": "k8minion2-1 Private IP",
                   "Value": {
                               "Ref": "MCGW11PrivateIP"
                       }
           },
           "MCGW21PrivateIP": {
                   "Description": "k8minion2-1 Private IP",
                   "Value": {
                               "Ref": "MCGW21PrivateIP"
                       }
           },
           "SSHtoContrailCommand": {
                   "Description": "SSH to contrail command",
                   "Value": { "Fn::Join": [ "", [ "   ssh -i [your OneClickKey1 private key file] centos@", {"Ref": "IPAddress"}, "" ] ] }
           },
           "SSHtoContrailController": {
                   "Description": "SSH to contrail controller and k8master",
                   "Value": { "Fn::Join": [ "", [ "   ssh -i [your OneClickKey1 private key file] centos@", {"Ref": "IPAddress"}, " -p 1139" ] ] }
           },
           "SSHtoContrailMinion11": {
                   "Description": "SSH to k8minion1-1",
                   "Value": { "Fn::Join": [ "", [ "   ssh -i [your OneClickKey1 private key file] centos@", {"Ref": "IPAddress"}, " -p 2140" ] ] }
           },
           "SSHtoContrailMinion21": {
                   "Description": "SSH to k8minion2-1",
                   "Value": { "Fn::Join": [ "", [ "   ssh -i [your OneClickKey1 private key file] centos@", {"Ref": "IPAddress"}, " -p 3140" ] ] }
           },
           "SSHtoMCGW11": {
                   "Description": "SSH to MCGW1-1",
                   "Value": { "Fn::Join": [ "", [ "   ssh -i [your OneClickKey1 private key file] centos@", {"Ref": "IPAddress"}, " -p 2138" ] ] }
           },
           "SSHtoMCGW21": {
                   "Description": "SSH to MCGW2-1",
                   "Value": { "Fn::Join": [ "", [ "   ssh -i [your OneClickKey1 private key file] centos@", {"Ref": "IPAddress"}, " -p 3138" ] ] }
           }
    }
}
